@startuml Data Pipeline
skinparam shadowing false
skinparam componentBorderColor #232F3E
skinparam componentBorderThickness 2
skinparam databaseBorderColor #146EB4
skinparam ArrowThickness 2
skinparam packageStyle rectangle
top to bottom direction

title Project Cost Control - Data Pipeline\nFrom Input to Reporting

' ===== LAYER 1: INPUT =====
package "1. Input Sources" #FAFAFA {
  actor "Project Manager\n/ Admin" as Users
  component [Excel Import\n(Future)] as Excel #D3D3D3
  component [Spectrum ERP\n(Future)] as Spectrum #D3D3D3
}

' ===== LAYER 2: DATA ENTRY =====
package "2. Data Entry Screens" #FFE6CC {
  component [Project\nSetup] as Setup #FF9900
  component [Budget\nEntry] as Budget #FF9900
  component [Employee\nRoster] as Employees #FF9900
  component [Daily Time\nEntry] as TimeEntry #FF9900
  component [Manual\nActuals] as ManualActuals #FF9900
}

' ===== LAYER 3: STORAGE =====
package "3. Data Storage (Aurora PostgreSQL)" #E6F3FF {
  database "PROJECTS" as ProjDB
  database "BUDGET_LINES" as BudgetDB
  database "EMPLOYEES" as EmpDB
  database "DAILY_TIME_ENTRIES" as TimeDB
  database "ACTUALS" as ActualsDB
  database "PROJECTION_SNAPSHOTS\n+ PROJECTION_DETAILS" as ProjSnapDB
}

' ===== LAYER 4: CALCULATIONS =====
package "4. Calculation Engine (Lambda)" #E6FFE6 {
  component [Aggregate Time\nto Monthly Actuals] as AggTime #7AA116
  note bottom of AggTime
    Labor Actuals =
      SUM(ST x Rate x Burden) +
      SUM(OT x Rate x 1.5 x Burden) +
      SUM(DT x Rate x 2.0 x Burden)
    Grouped by: Project, Cost Code, Month
  end note

  component [Calculate GP\n& Variance] as CalcGP #7AA116
  note bottom of CalcGP
    GP = Contract - Total Costs
    GP% = GP / Contract x 100
    Variance = Budget - Forecast
  end note

  component [Build\nProjections] as CalcProj #7AA116
  note bottom of CalcProj
    1. % complete = Actuals / Budget
    2. Remaining = Budget - Actuals
    3. Forecast = Actuals + Remaining
    4. Projected GP = Contract - Forecast
  end note
}

' ===== LAYER 5: OUTPUTS =====
package "5. Reports & Dashboards" #E6E6FF {
  component [Dashboard\n(Project Health)] as Dashboard #146EB4
  component [Budget vs\nActual Report] as BvA #146EB4
  component [GP Analysis\nReport] as GPAnalysis #146EB4
  component [Projection\nHistory] as ProjReports #146EB4
  component [Export PDF\n/ Excel (Future)] as Export #D3D3D3
}

' ===== FLOW: Input -> Entry =====
Users --> Setup
Users --> Budget
Users --> Employees
Users --> TimeEntry
Users --> ManualActuals
Excel ..> Budget : future
Spectrum ..> TimeEntry : future

' ===== FLOW: Entry -> Storage (1:1, clean) =====
Setup --> ProjDB
Budget --> BudgetDB
Employees --> EmpDB
TimeEntry --> TimeDB
ManualActuals --> ActualsDB

' ===== FLOW: Storage -> Calculations =====
TimeDB --> AggTime
EmpDB --> AggTime : labor rates
AggTime --> ActualsDB : aggregated\nlabor actuals

ProjDB --> CalcGP : contract amount
BudgetDB --> CalcGP : budgeted amounts
ActualsDB --> CalcGP : actual costs

BudgetDB --> CalcProj : remaining budget
ActualsDB --> CalcProj : historical actuals
CalcProj --> ProjSnapDB : save snapshot

' ===== FLOW: Calculations -> Outputs =====
CalcGP --> Dashboard
CalcGP --> GPAnalysis
CalcProj --> Dashboard
CalcProj --> ProjReports

BudgetDB --> BvA
ActualsDB --> BvA

Dashboard --> Export
BvA --> Export
GPAnalysis --> Export
ProjReports --> Export

legend bottom
  <b>Data Pipeline Layers</b>
  |= Layer |= Purpose |= Color |
  | 1. Input | Users and external systems | White |
  | 2. Entry | Data entry screens (React) | <#FF9900> Orange |
  | 3. Storage | Aurora PostgreSQL tables | <#E6F3FF> Blue |
  | 4. Calculations | Lambda business logic | <#7AA116> Green |
  | 5. Outputs | Dashboards and reports | <#146EB4> Dark Blue |
  | Future | Excel import, Spectrum, PDF export | <#D3D3D3> Gray |
  
  <b>Key Flow:</b>
  Daily Time Entry -> Aggregate by Month -> ACTUALS -> GP Calc -> Dashboard
endlegend

@enduml
