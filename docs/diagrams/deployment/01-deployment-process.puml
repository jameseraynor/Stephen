@startuml Deployment Diagram
skinparam shadowing false
skinparam nodeBorderColor #232F3E
skinparam nodeBorderThickness 2
skinparam componentBorderColor #146EB4
skinparam ArrowThickness 2
skinparam linetype ortho

title Deployment Process\nAWS CDK Infrastructure as Code

' ===== DEVELOPMENT =====
node "Developer Workstation" #FFE6CC {
  component [Source Code\n(TypeScript)] as code
  component [AWS CDK CLI] as cdk
  component [npm build] as npm
}

cloud "GitHub" #E6F3FF {
  component [Git Repository] as git
}

' ===== AWS - DEPLOYMENT PIPELINE =====
cloud "AWS Account" {

  node "CloudFormation" #FF9900 {
    component [Stack Templates\n(synthesized from CDK)] as cfn
  }

  ' --- Deployment Targets ---
  together {
    node "S3 Buckets" #FF9900 {
      component [Frontend Bucket\n(React SPA)] as s3frontend
      component [Lambda Code Bucket\n(ZIP bundles)] as s3lambda
    }

    node "CloudFront" #FF9900 {
      component [CDN Distribution\n(Edge Locations)] as edge
    }
  }

  together {
    node "Cognito" #DD344C {
      component [User Pool\n(SSO + MFA)] as cognito
    }

    node "API Gateway" #146EB4 {
      component [REST API\n+ Cognito Authorizer] as apigw
    }
  }

  node "Lambda Functions" #7AA116 {
    component [Projects | Budget | Employees\nTime Entry | Actuals | Projections\n(Node.js 24, TypeScript)] as lambdas
  }

  together {
    node "Secrets Manager" #DD344C {
      component [DB Credentials\n(auto-rotated)] as secrets
    }

    node "VPC - Private Subnet" #E6E6E6 {
      database "Aurora Serverless v2\nPostgreSQL 16\n(0.5-2 ACU)" as aurora
    }

    node "CloudWatch" #FF9900 {
      component [Logs | Metrics | Alarms] as monitoring
    }
  }
}

' ===== DEPLOYMENT FLOW (left side) =====
code --> git : 1. Push code
code --> npm : 2. Build frontend + backend
npm --> cdk : 3. cdk deploy

cdk --> cfn : 4. Synthesize\ntemplates

cfn --> s3frontend : Create/update
cfn --> s3lambda : Create/update
cfn --> edge : Create/update
cfn --> cognito : Create/update
cfn --> apigw : Create/update
cfn --> lambdas : Deploy functions
cfn --> aurora : Create cluster
cfn --> secrets : Create secrets
cfn --> monitoring : Create log groups

' ===== CODE DEPLOYMENT =====
npm --> s3frontend : Upload static files\n(HTML, JS, CSS)
npm --> s3lambda : Upload Lambda ZIPs

s3frontend --> edge : Origin source
s3lambda --> lambdas : Code source

' ===== RUNTIME FLOW =====
edge --> apigw : API requests\n(HTTPS)
apigw --> cognito : Validate JWT
apigw --> lambdas : Invoke handler

lambdas --> secrets : Get DB credentials\n(cached)
lambdas --> aurora : SQL queries\n(connection pool)
lambdas --> monitoring : Structured logs

note right of cdk #FEFECE
  <b>Deployment Commands:</b>
  1. cdk bootstrap (first time)
  2. cdk synth (generate templates)
  3. cdk diff (preview changes)
  4. cdk deploy --all (deploy)
  
  <b>Environments:</b>
  dev | prod
end note

note right of lambdas #E6FFE6
  <b>6 Lambda Functions:</b>
  Each follows same pattern:
  1. Auth (Cognito JWT)
  2. Validate (Zod)
  3. Query (Aurora)
  4. Respond (JSON)
  
  Shared code via src/shared/
end note

note right of aurora #FFE6E6
  <b>Database Setup:</b>
  1. CDK creates cluster
  2. Run migrations:
     ./database/scripts/migrate.sh
  3. Seed data (optional):
     ./database/scripts/seed-db.sh
  
  10 tables, UUID PKs
end note

note bottom of monitoring
  <b>Observability:</b>
  Logs -> Metrics -> Alarms
  Alert on: error rate >5%,
  DB connections >80%,
  auth failures >50/min
end note

legend bottom
  <b>Deployment vs Runtime</b>
  |= Phase |= Flow |= Frequency |
  | Build | Source -> npm build -> artifacts | Every deploy |
  | Deploy | CDK -> CloudFormation -> AWS resources | Every deploy |
  | Code Push | S3 -> Lambda / CloudFront | Every deploy |
  | Runtime | CloudFront -> API GW -> Lambda -> Aurora | Every request |
  
  |= Color |= Service Type |
  |<#FFE6CC>| Development |
  |<#FF9900>| Content Delivery & Monitoring |
  |<#146EB4>| API Layer |
  |<#7AA116>| Compute |
  |<#DD344C>| Security |
  |<#E6E6E6>| Network / Database |
endlegend

@enduml
