@startuml 04-backend-service-layers
skinparam linetype ortho
skinparam shadowing false
skinparam defaultTextAlignment center
skinparam ArrowColor #232F3E
skinparam ArrowThickness 2
skinparam packageStyle rectangle
top to bottom direction

title Backend Service Layers\n8 Domain-Grouped Lambdas + Shared Modules

' ===== API GATEWAY =====
package "API Gateway (REST)" #FFE6CC {
  component [Cognito\nAuthorizer] as CognitoAuth #DD344C
  component [Request\nValidator] as ReqValidator #FF9900
}

' ===== LAMBDA HANDLERS =====
package "Lambda Handlers (1 per domain, internal routing)" #E6F3FF {
  package "#1 Projects" #lightblue {
    component [index.ts\n─────────────\nGET /projects\nGET /projects/{id}\nPOST /projects\nPUT /projects/{id}\nDELETE /projects/{id}] as ProjRouter
  }

  package "#2 Project Summary" #lightblue {
    component [summary.ts\n─────────────\nGET /projects/{id}/summary\n(higher memory/timeout)] as ProjSummary
  }

  package "#3 Budget" #lightgreen {
    component [index.ts\n─────────────\nGET ../budget\nPOST ../budget\nPUT ../budget/{lineId}\nDELETE ../budget/{lineId}] as BudgRouter
  }

  package "#4 Employees" #lightyellow {
    component [index.ts\n─────────────\nGET ../employees\nPOST ../employees\nPUT ../employees/{id}\nDELETE ../employees/{id}] as EmpRouter
  }

  package "#5 Time Entries" #FFE6E6 {
    component [index.ts\n─────────────\nGET ../time-entries\nPOST ../time-entries\nPUT /time-entries/{id}\nDELETE /time-entries/{id}] as TERouter
  }

  package "#6 Actuals" #E6FFE6 {
    component [index.ts\n─────────────\nGET ../actuals\nGET ../actuals/{month}\nPOST ../actuals (upsert)] as ActRouter
  }

  package "#7 Projections" #F0E6FF {
    component [index.ts\n─────────────\nGET ../projections\nGET ../projections/{id}\nPOST ../projections\nPUT ../projections/{id}\nDELETE ../projections/{id}] as PrjRouter
  }

  package "#8 Reference Data" #F5F5F5 {
    component [index.ts\n─────────────\nGET /cost-codes\nGET /cost-codes/{id}\nGET /labor-rates\n(read-only, combined)] as RefRouter
  }
}

' ===== SHARED MODULES =====
package "Shared Modules (src/shared/)" #FAFAFA {
  component [auth.ts\n─────────────\ngetUserFromEvent()\nhasRole()\nrequireRole()] as Auth #DD344C

  component [validation.ts\n─────────────\nvalidateBody()\nvalidateQuery()\nvalidatePathParam()\ncommonSchemas] as Validation #FF9900

  component [response.ts\n─────────────\nsuccessResponse()\nerrorResponse()\nApiError class] as Response #146EB4

  component [db.ts\n─────────────\nquery()\ntransaction()\nvia RDS Proxy] as Db #7AA116

  component [logger.ts\n─────────────\nPowertools Logger\nStructured JSON] as Logger #232F3E

  component [secrets.ts\n─────────────\ngetSecret()\ncachedCredentials] as Secrets #DD344C
}

' ===== TYPES =====
package "Types (src/types/)" #F0F0F0 {
  component [index.ts\n─────────────\nZod Schemas\nTS Interfaces\nValidation Helpers] as Types #232F3E
}

' ===== EXTERNAL SERVICES =====
package "AWS Services" #FFE6CC {
  rectangle "RDS Proxy\nConnection Pooling" as RDSProxy #146EB4
  database "Aurora\nPostgreSQL 16" as Aurora #146EB4
  component [Secrets\nManager] as SM #DD344C
  component [CloudWatch\nLogs] as CW #FF9900
}

' ===== FLOW: API Gateway -> Handlers =====
CognitoAuth --> ReqValidator
ReqValidator --> ProjRouter
ReqValidator --> ProjSummary
ReqValidator --> BudgRouter
ReqValidator --> EmpRouter
ReqValidator --> TERouter
ReqValidator --> ActRouter
ReqValidator --> PrjRouter
ReqValidator --> RefRouter

' ===== FLOW: Handlers -> Shared =====
ProjRouter ..> Auth : 1. Authenticate
ProjRouter ..> Validation : 2. Validate
ProjRouter ..> Db : 3. Query
ProjRouter ..> Response : 4. Respond
ProjRouter ..> Logger : logging

ProjSummary ..> Auth
ProjSummary ..> Db
ProjSummary ..> Response

' ===== FLOW: Shared -> External =====
Db --> RDSProxy
RDSProxy --> Aurora
Db ..> Secrets : credentials
Secrets --> SM
Logger --> CW

' ===== FLOW: Shared -> Types =====
Validation ..> Types : schemas
Auth ..> Types : CognitoUser

note right of Auth
  <b>Internal Routing Pattern:</b>
  Each Lambda routes by httpMethod:
  ──────────────────────────
  switch (event.httpMethod) {
    case 'GET':  → list or get
    case 'POST': → create
    case 'PUT':  → update
    case 'DELETE': → delete
  }
  ──────────────────────────
  8 Lambdas handle ~30 endpoints
end note

note right of Db
  <b>Connection via RDS Proxy:</b>
  * pg.Client (single connection)
  * NOT pg.Pool (proxy handles pooling)
  * SSL enabled
  * Reuses across invocations
  * transaction() for multi-table ops
end note

note bottom of Types
  <b>Zod Schemas -> TypeScript Types</b>
  * Runtime + compile-time validation
  * snake_case for DB, camelCase for API
end note

legend bottom
  <b>Lambda Service Map (8 total)</b>
  |= # |= Lambda |= Routes |= Methods |
  | 1 | projects | /projects, /projects/{id} | GET POST PUT DELETE |
  | 2 | project-summary | /projects/{id}/summary | GET |
  | 3 | budget | ../budget, ../budget/{lineId} | GET POST PUT DELETE |
  | 4 | employees | ../employees, ../employees/{id} | GET POST PUT DELETE |
  | 5 | time-entries | ../time-entries, /time-entries/{id} | GET POST PUT DELETE |
  | 6 | actuals | ../actuals, ../actuals/{month} | GET POST |
  | 7 | projections | ../projections, ../projections/{id} | GET POST PUT DELETE |
  | 8 | reference-data | /cost-codes, /labor-rates | GET |
endlegend

@enduml
