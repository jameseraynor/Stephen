@startuml 01-aws-infrastructure
skinparam linetype ortho
skinparam defaultTextAlignment center
skinparam shadowing false
skinparam ArrowThickness 2
skinparam packageStyle rectangle

title AWS Architecture - Project Cost Control System\nServerless Architecture (8 Domain-Grouped Lambdas)

actor "End Users" as users

package "Presentation Layer" {
    rectangle "CloudFront\nCDN Distribution\nGlobal Edge Locations" as cloudfront #FF9900
    rectangle "S3 Bucket\nStatic Hosting\nReact SPA Assets" as s3 #FF9900
}

package "Security & Identity" {
    rectangle "Cognito User Pool\nAuthentication\nEmail + Microsoft SSO\nMFA Enabled" as cognito #DD344C
}

package "API Gateway Layer" {
    rectangle "API Gateway\nREST API\nCognito Authorizer\nRate Limit: 100 req/s" as apigw #146EB4
}

package "Compute Layer - 8 Lambda Functions" {
    rectangle "Projects\nindex.ts\nCRUD /projects" as lambda_projects #7AA116
    rectangle "Project Summary\nsummary.ts\nGET /projects/{id}/summary\n(512MB, 30s timeout)" as lambda_summary #7AA116
    rectangle "Budget\nindex.ts\nCRUD ../budget" as lambda_budget #7AA116
    rectangle "Employees\nindex.ts\nCRUD ../employees" as lambda_employees #7AA116
    rectangle "Time Entries\nindex.ts\nCRUD ../time-entries" as lambda_time #7AA116
    rectangle "Actuals\nindex.ts\nGET+POST ../actuals" as lambda_actuals #7AA116
    rectangle "Projections\nindex.ts\nCRUD ../projections" as lambda_projections #7AA116
    rectangle "Reference Data\nindex.ts\nGET /cost-codes\nGET /labor-rates" as lambda_refdata #7AA116
}

package "Data Layer" {
    rectangle "VPC\nPrivate Network" as vpc #lightgray {
        rectangle "RDS Proxy\nConnection Pooling\nManaged by AWS" as rdsproxy #146EB4
        database "Aurora Serverless v2\nPostgreSQL 16\nScaling: 0.5-2 ACU\nEncrypted at Rest" as aurora #146EB4
    }
}

package "Supporting Services" {
    rectangle "Secrets Manager\nDB Credentials\nAuto-Rotation" as secrets #DD344C
    rectangle "CloudWatch\nLogs & Metrics\nX-Ray Tracing" as cloudwatch #FF9900
}

' User to Frontend
users -[#FF9900,thickness=3]down-> cloudfront : 1. HTTPS Request
cloudfront -[#FF9900]down-> s3 : 2. Fetch Assets

' User to API
users -[#146EB4,thickness=3]down-> apigw : 3. API Calls\n(JWT Token)

' API Gateway to Auth
apigw -[#DD344C]right-> cognito : 4. Validate JWT

' API Gateway to Lambda
apigw -[#7AA116]down-> lambda_projects : 5a
apigw -[#7AA116]down-> lambda_summary : 5b
apigw -[#7AA116]down-> lambda_budget : 5c
apigw -[#7AA116]down-> lambda_employees : 5d
apigw -[#7AA116]down-> lambda_time : 5e
apigw -[#7AA116]down-> lambda_actuals : 5f
apigw -[#7AA116]down-> lambda_projections : 5g
apigw -[#7AA116]down-> lambda_refdata : 5h

' Lambda to Secrets
lambda_projects -[#DD344C]right-> secrets : 6. Get Credentials

' Lambda to RDS Proxy to Database
lambda_projects -[#146EB4]down-> rdsproxy : 7. pg.Client
lambda_summary -[#146EB4]down-> rdsproxy
lambda_budget -[#146EB4]down-> rdsproxy
lambda_employees -[#146EB4]down-> rdsproxy
lambda_time -[#146EB4]down-> rdsproxy
lambda_actuals -[#146EB4]down-> rdsproxy
lambda_projections -[#146EB4]down-> rdsproxy
lambda_refdata -[#146EB4]down-> rdsproxy
rdsproxy -[#146EB4]down-> aurora : Pooled connections

' Lambda to CloudWatch
lambda_projects -[#FF9900]left-> cloudwatch : 8. Logs

note right of cognito #FEFECE
  <b>Authentication Features:</b>
  * Email/Password Login
  * Microsoft SSO (SAML)
  * MFA via TOTP
  * User Groups: Admin, PM, Viewer
  * Password Policy: 12+ chars
end note

note bottom of aurora #E6F3FF
  <b>Database Configuration:</b>
  * Auto-scaling: 0.5-2 ACU
  * Private subnet (no internet)
  * Encryption: AES-256
  * Automated backups: 7 days
end note

note left of rdsproxy #E6F3FF
  <b>RDS Proxy:</b>
  * Centralized connection pooling
  * Prevents Lambda connection exhaustion
  * Automatic failover
  * Credential rotation
end note

legend right
  <b>Legend</b>
  |= Color |= Service Type |
  |<#FF9900> | Content Delivery & Monitoring |
  |<#146EB4> | API & Database |
  |<#7AA116> | Compute (Lambda) |
  |<#DD344C> | Security Services |
  
  <b>8 Lambdas â†’ ~30 Endpoints</b>
  Each Lambda routes internally by HTTP method.
  Domain grouping shares DB connections & cold starts.
  
  <b>Architecture Highlights:</b>
  * Fully serverless (no EC2)
  * RDS Proxy for connection pooling
  * Lambda Powertools for observability
  * Auto-scaling at all layers
  * Pay-per-use pricing
endlegend

@enduml
